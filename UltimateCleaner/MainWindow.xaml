<Window x:Class="MemoryCleaner.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:MemoryCleaner.Infrastructure"
        Title="MemoryCleaner"
        Width="1150" Height="700"
        WindowStartupLocation="CenterScreen"
        ResizeMode="CanResize"
        Background="#F3F4F6"
        WindowStyle="SingleBorderWindow">

    <Window.Resources>
        <local:SizeUnitMultiConverter x:Key="SizeUnitMultiConverter"/>
        <local:BoolToTypeConverter x:Key="BoolToTypeConverter"/>

        <Style TargetType="Button">
            <Setter Property="Padding" Value="10,4"/>
            <Setter Property="Margin" Value="0,0,6,0"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Background" Value="#2563EB"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                CornerRadius="6"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="CardStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderBrush" Value="#E5E7EB"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="Margin" Value="0,0,10,0"/>
        </Style>
    </Window.Resources>

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Верхняя панель -->
        <Border Grid.Row="0" Style="{StaticResource CardStyle}">
            <StackPanel>
                <WrapPanel>
                    <TextBlock Text="Диск:" Margin="0,0,6,0" VerticalAlignment="Center"/>
                    <ComboBox Width="130" ItemsSource="{Binding Drives}" SelectedItem="{Binding SelectedDrive}" Margin="0,0,12,0"/>

                    <TextBlock Text="Top:" Margin="0,0,6,0" VerticalAlignment="Center"/>
                    <TextBox Width="70" Text="{Binding TopN}" Margin="0,0,12,0"/>

                    <TextBlock Text="Ед:" Margin="0,0,6,0" VerticalAlignment="Center"/>
                    <ComboBox Width="90" ItemsSource="{Binding Units}" SelectedItem="{Binding SelectedUnit}" Margin="0,0,12,0"/>

                    <Button Content="Анализ" Command="{Binding AnalyzeCommand}"/>
                    <Button Content="Отмена" Background="#6B7280" Command="{Binding CancelCommand}"/>

                    <ProgressBar Width="180" Height="14" Margin="8,0,0,0" IsIndeterminate="{Binding IsBusy}" VerticalAlignment="Center"/>
                </WrapPanel>

                <WrapPanel Margin="0,10,0,0">
                    <Button Content="Очистить TEMP (пользователь)" Background="#10B981"
                            Command="{Binding CleanUserTempCommand}"/>
                    <Button Content="Очистить TEMP (Windows)" Background="#10B981"
                            Command="{Binding CleanWindowsTempCommand}"/>
                    <Button Content="DISM: StartComponentCleanup" Background="#F59E0B"
                            Command="{Binding DismCleanupCommand}"/>
                    <CheckBox Content="ResetBase (без отката)" IsChecked="{Binding DismResetBase}" VerticalAlignment="Center" Margin="8,0,0,0"/>
                </WrapPanel>

                <TextBlock Margin="0,10,0,0" Text="{Binding DiskSummary}" FontSize="14"/>
            </StackPanel>
        </Border>

        <!-- Основной контент -->
        <Grid Grid.Row="1" Margin="0,12,0,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Топ папок -->
            <Border Grid.Column="0" Style="{StaticResource CardStyle}">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top" Text="Топ папок" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,8"/>
                    <DataGrid ItemsSource="{Binding TopFolders}" SelectedItem="{Binding SelectedFolder}"
                              AutoGenerateColumns="False" IsReadOnly="True" CanUserAddRows="False" GridLinesVisibility="None">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Папка" Binding="{Binding Path}" Width="*"/>
                            <DataGridTemplateColumn Header="Размер" Width="150">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock HorizontalAlignment="Right">
                                            <TextBlock.Text>
                                                <MultiBinding Converter="{StaticResource SizeUnitMultiConverter}">
                                                    <Binding Path="SizeBytes"/>
                                                    <Binding Path="DataContext.SelectedUnit"
                                                             RelativeSource="{RelativeSource AncestorType=Window}"/>
                                                </MultiBinding>
                                            </TextBlock.Text>
                                        </TextBlock>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </Border>

            <!-- Содержимое папки -->
            <Border Grid.Column="1" Style="{StaticResource CardStyle}">
                <DockPanel>
                    <Grid DockPanel.Dock="Top" Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel>
                            <TextBlock Text="Содержимое" FontSize="16" FontWeight="SemiBold"/>
                            <TextBlock Text="{Binding CurrentFolderPath}" Foreground="#6B7280" TextTrimming="CharacterEllipsis"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1" Orientation="Horizontal">
                            <Button Content="Назад" Background="#6B7280" Command="{Binding BackCommand}" Margin="0,0,8,0"/>
                            <Button Content="Проводник" Command="{Binding OpenInExplorerCommand}"/>
                        </StackPanel>
                    </Grid>

                    <DataGrid ItemsSource="{Binding FolderEntries}" SelectedItem="{Binding SelectedEntry}"
                              AutoGenerateColumns="False" IsReadOnly="True" CanUserAddRows="False" GridLinesVisibility="None">
                        <DataGrid.InputBindings>
                            <MouseBinding MouseAction="LeftDoubleClick" Command="{Binding OpenSelectedEntryCommand}"/>
                        </DataGrid.InputBindings>
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Имя" Binding="{Binding Name}" Width="*"/>
                            <DataGridTextColumn Header="Тип" Width="100"
                                                Binding="{Binding IsDirectory, Converter={StaticResource BoolToTypeConverter}}"/>
                            <DataGridTemplateColumn Header="Размер" Width="140">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock HorizontalAlignment="Right">
                                            <TextBlock.Text>
                                                <MultiBinding Converter="{StaticResource SizeUnitMultiConverter}">
                                                    <Binding Path="SizeBytes"/>
                                                    <Binding Path="DataContext.SelectedUnit"
                                                             RelativeSource="{RelativeSource AncestorType=Window}"/>
                                                    <Binding Path="IsDirectory"/>
                                                </MultiBinding>
                                            </TextBlock.Text>
                                        </TextBlock>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="Изменено" Width="160"
                                                Binding="{Binding LastWriteTime, StringFormat=yyyy-MM-dd HH:mm}"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </Border>
        </Grid>

        <!-- Статус -->
        <Border Grid.Row="2" Style="{StaticResource CardStyle}">
            <TextBlock Text="{Binding Status}" />
        </Border>
    </Grid>
</Window>
